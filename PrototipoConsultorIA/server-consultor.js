// Archivo: server-consultor.js

const express = require('express');
const cors = require('cors');
require('dotenv').config(); 

// üö® USAR PUERTO 3003 para el Consultor
const app = express();
const PORT = 3003; 

// URL de ejemplo para casos complejos y gu√≠as oficiales
const LINK_INPI = "https://www.argentina.gob.ar/inpi"; 
const LINK_EMPRESA = "https://www.argentina.gob.ar/produccion/crear-una-empresa";
// üö® Nuevo link para Aut√≥nomos
const LINK_AUTONOMOS = "https://www.argentina.gob.ar/afip/autonomos"; 
// üö® Nuevo link para tr√°mites a distancia (TAD)
const LINK_TAD = "https://www.tramitesadistancia.gob.ar/";

// Configuraci√≥n de Middlewares
app.use(cors()); 
app.use(express.json()); 
app.use(express.urlencoded({ extended: true })); 

// ---------------------------------------------
// DEFINICIONES DE RESPUESTAS (MEN√ö DE OPCIONES)
// ---------------------------------------------

const TRAMITES_HTML = `<a href="${LINK_TAD}" target="_blank">tramitesadistancia.gob.ar</a>`;
const EMPRESA_HTML = `<a href="${LINK_EMPRESA}" target="_blank">Argentina.gob.ar - C√≥mo crear una empresa</a>`;
const AUTONOMOS_HTML = `<a href="${LINK_AUTONOMOS}" target="_blank">Argentina.gob.ar - Aut√≥nomos</a>`;

// URLs de im√°genes para dise√±o de marca
const IMAGE_URL_1 = "https://tse4.mm.bing.net/th/id/OIP.eYEeWyjzgxgfFRfehP53-gHaHa?pid=Api&P=0&h=180";
const IMAGE_URL_2 = "https://tse2.mm.bing.net/th/id/OIP.4uSkyto8YLmAok12PG-f_QHaHQ?pid=Api&P=0&h=180";


const TRIGGERS_MENU = {
    // ---------------------------------------------
    // Opci√≥n 1 del men√∫ principal: INICIO DEL FLUJO IVA
    // ---------------------------------------------
    "iva": [
        // MENSAJE 1 (Explicaci√≥n principal)
        { text: "Te comento üëâ el **IVA** es el impuesto que vas a tener que declarar y pagar como parte de tu actividad. Cada vez que factur√°s a un cliente, sum√°s el IVA a tu precio (por ejemplo, 21%). Ese monto no es tuyo, sino que luego lo ten√©s que ingresar a ARCA.\n\nA la vez, pod√©s descontar el IVA que pagaste en tus compras relacionadas con tu trabajo (cr√©dito fiscal). La diferencia entre lo que cobr√°s y lo que pagaste es lo que se declara y se paga mensualmente.\n\nEn pocas palabras: factur√°s con IVA, lo cobr√°s, pero no lo reten√©s ‚Äî lo liquid√°s y pag√°s al Estado." },
        
        // MENSAJE 2 (Motivaci√≥n y men√∫ de seguimiento)
        { text: `**üí° ¬°Me alegra que te interese este tema, est√°s dando pasos clave para tu emprendimiento!**

üëâ **¬øQuer√©s que lo veamos m√°s en detalle?** Escrib√≠ la palabra clave de la opci√≥n:

1Ô∏è‚É£ **Ampliada** ‚Üí Concepto IVA para emprendedores

2Ô∏è‚É£ **Ejemplo** ‚Üí Caso pr√°ctico con n√∫meros

3Ô∏è‚É£ **Obligaciones** ‚Üí Requisitos b√°sicos frente a ARCA` }
    ],

    // Sub-opci√≥n 1.1: RESPUESTA AMPLIADA (Trigger: "ampliada" o "1")
    "ampliada": {
        text: `üìò **Respuesta ampliada: ¬øQu√© es el IVA para vos como emprendedor?**

El IVA (Impuesto al Valor Agregado) grava la venta de bienes y servicios. No es un costo tuyo, sino un impuesto que cobr√°s y luego traslad√°s al fisco.

--- 

**Escribe 2 para Ejemplo o 3 para Obligaciones.**`
    },
    
    // Sub-opci√≥n 1.2: EJEMPLO PR√ÅCTICO (Trigger: "ejemplo" o "2")
    "ejemplo": {
        text: `üìä **Ejemplo pr√°ctico con n√∫meros:**

- Emit√≠s una factura por tu servicio de $100.000.
- Sum√°s 21% de IVA ‚Üí $21.000.
- Total facturado al cliente = $121.000.
- Ese $21.000 no te lo qued√°s: lo declar√°s a ARCA.
- Si en ese mes pagaste $5.000 de IVA en insumos, pod√©s descontarlos. Entonces pagar√≠as **$16.000** (21.000 ‚àí 5.000).

--- 

**Escribe 1 para Ampliada o 3 para Obligaciones.**`
    },
    
    // Sub-opci√≥n 1.3: OBLIGACIONES B√ÅSICAS (Trigger: "obligaciones" o "3")
    "obligaciones": {
        // AJUSTE: Doble salto de l√≠nea antes del submen√∫ final
        text: `üìù **Obligaciones b√°sicas:**

- Estar inscripto en ARCA como Responsable Inscripto.
- Emitir facturas con IVA discriminado.
- Presentar la Declaraci√≥n Jurada mensual de IVA.
- Ingresar el pago en los vencimientos que marca el calendario fiscal.

--- 

**Escribe 1 para Ampliada o 2 para Ejemplo.**`
    },
    
    // ---------------------------------------------
    // Opci√≥n 2 del men√∫ principal: INICIO DEL FLUJO EMPRESA (CORREGIDO ESPACIOS)
    // ---------------------------------------------
    "empresa": [
        // MENSAJE 1 (Pasos principales + Link oficial) - CORREGIDO CON \n\n
        { text: `üëâ **Formalizar tu negocio es un gran paso.** Aqu√≠ tienes los **4 puntos clave** para crear tu empresa:

1Ô∏è‚É£ **Elegir la figura legal** (ejemplo: Monotributo, SRL, SA, SAS).

2Ô∏è‚É£ **Registrar la sociedad** en la Inspecci√≥n General de Justicia (IGJ) o en el organismo provincial correspondiente.

3Ô∏è‚É£ **Solicitar el CUIT** en AFIP y dar de alta la actividad.

4Ô∏è‚É£ **Cumplir obligaciones** impositivas y laborales seg√∫n la forma legal elegida.

üîó Pod√©s ver la gu√≠a oficial en ${EMPRESA_HTML}

Escribe **"m√°s info"** para ver los detalles.` },
    ],

    // NUEVO TRIGGER: Sub-men√∫ y motivaci√≥n para empresa (Trigger: "masinfo") - CORREGIDO CON ESPACIO
    "masinfo": {
        text: `üöÄ **¬°Felicitaciones! Est√°s a un paso de formalizar tu emprendimiento.** Te cuento c√≥mo arrancar:

Escrib√≠ la palabra clave de la opci√≥n para ver m√°s informaci√≥n:

1Ô∏è‚É£ **legales** ‚Üí formas legales (SRL, SA, SAS, Monotributo)

2Ô∏è‚É£ **tramites** ‚Üí tr√°mites iniciales (CUIT, inscripci√≥n AFIP, estatuto)

3Ô∏è‚É£ **recomendaciones** ‚Üí recomendaciones (contadores, costos y tiempos)`
    },

    // Sub-opci√≥n 2.1: FORMAS LEGALES (Trigger: "legales" o "1")
    "legales": {
        text: `‚úÖ **Formas legales**

Pod√©s elegir entre:

- üë§ **Monotributo:** La forma m√°s simple si trabaj√°s solo y cumpl√≠s con los l√≠mites de facturaci√≥n.
- üöÄ **SAS** (Sociedad por Acciones Simplificada): √Ågil, se constituye online y con menos requisitos, ideal para emprendedores.
- ü§ù **SRL** (Sociedad de Responsabilidad Limitada): Muy usada en PyMEs, con responsabilidad limitada al capital aportado.
- üèõÔ∏è **SA** (Sociedad An√≥nima): M√°s formal, estructura compleja, suele usarse en grandes empresas o para atraer inversi√≥n.

--- 

**Escribe 2 para Tr√°mites o 3 para Recomendaciones.**`
    },
    
    // Sub-opci√≥n 2.2: TR√ÅMITES INICIALES (Trigger: "tramites" o "2")
    "tramites": {
        text: `üìù **Tr√°mites iniciales**

Los pasos b√°sicos son:

1Ô∏è‚É£ **Obtener CUIT** en AFIP.

2Ô∏è‚É£ **Registrar la sociedad** (en la IGJ o registro provincial).

3Ô∏è‚É£ **Redactar y presentar el estatuto** (documento clave que define las reglas internas de la empresa).

--- 

**Escribe 1 para Formas Legales o 3 para Recomendaciones.**`
    },
    
    // Sub-opci√≥n 2.3: RECOMENDACIONES (Trigger: "recomendaciones" o "3")
    "recomendaciones": {
        // AJUSTE: Doble salto de l√≠nea antes del submen√∫ final
        text: `üß≠ **Recomendaciones clave**

- **Contador:** Consult√° a un profesional para definir la figura legal m√°s conveniente y evitar errores costos os.
- **Costos y Tiempos:** Ten√© en cuenta los costos de inscripci√≥n (tasas) y los tiempos de aprobaci√≥n, que var√≠an mucho seg√∫n la forma legal elegida (la SAS suele ser la m√°s r√°pida).
- **Planificaci√≥n:** Planific√° las obligaciones impositivas (IVA, Ganancias, Ingresos Brutos) y laborales que vas a asumir.

--- 

**Escribe 1 para Formas Legales o 2 para Tr√°mites.**`
    },
    
    // ---------------------------------------------
    // Opci√≥n 3 del men√∫ principal: AUT√ìNOMO (REQUISITOS) (CORREGIDO PREFIJO Y ESPACIOS)
    // ---------------------------------------------
    "aut√≥nomo": [
        // üö® Respuesta actualizada: Elimin√© "Opci√≥n 3" y us√© \n\n para listar
        { text: `**Requisitos para estar dado de alta como aut√≥nomo**

Para darte de alta como aut√≥nomo necesit√°s:

1Ô∏è‚É£ Tener **CUIT** (Clave √önica de Identificaci√≥n Tributaria).

2Ô∏è‚É£ Contar con **Clave Fiscal** con nivel de seguridad 2 o superior.

3Ô∏è‚É£ Ingresar al sistema de **AFIP** y declarar tus actividades econ√≥micas.

4Ô∏è‚É£ Obtener el **alta en el R√©gimen de Trabajadores Aut√≥nomos**

üîó Pod√©s ver la gu√≠a oficial paso a paso en ${AUTONOMOS_HTML}` }
    ]
};

// ---------------------------------------------
// L√≥gica de Detecci√≥n de Casos Complejos (Consulta Libre)
// ---------------------------------------------

function checkCasosConsultor(message) {
    const lowerCaseMessage = message.toLowerCase();
    
    // Detecta registro/registrar + marca
    const isRegistrationQuery = (lowerCaseMessage.includes("registrar") || lowerCaseMessage.includes("registro")) && lowerCaseMessage.includes("marca");
    // Detecta dise√±o + marca
    const isDesignQuery = lowerCaseMessage.includes("dise√±o") && lowerCaseMessage.includes("marca");

    // üö® FLUJO 1: Registro de Marca (Si es registro, pero NO dise√±o)
    if (isRegistrationQuery && !isDesignQuery) {
        return [
            { text: `üìå Ten√©s que iniciar el tr√°mite en el **INPI** (Instituto Nacional de la Propiedad Industrial). Lo hac√©s online en ${TRAMITES_HTML}.

üîó Pod√©s ver la gu√≠a oficial paso a paso en ${LINK_INPI}` }
        ];
    } 
    
    // üö® FLUJO 2: Dise√±o de Marca (Si es dise√±o, pero NO registro)
    if (isDesignQuery && !isRegistrationQuery) {
        // Flujo de 4 mensajes para dise√±o
        return [
            // Mensaje 1: Consejos de dise√±o
            { text: `üé® **Dise√±o de marca**

üöÄ **¬°Tu marca es tu carta de presentaci√≥n!**

üëâ Te sugerimos trabajar un logo simple, legible y adaptable (colores + tipograf√≠a clara).

üîó Pod√©s probar herramientas como Canva o FreeLogoDesign.` },
            
            // Mensaje 2: Presentaci√≥n de ejemplos visuales (Separado)
            { text: `üì∑ Te muestro 2 ejemplos visuales de inspiraci√≥n seg√∫n lo que us√°s hoy.` },
            
            // üõë CLAVE: Aqu√≠ se usa 'url' en lugar de 'text'
            { url: IMAGE_URL_1 }, 
            
            // üõë CLAVE: Aqu√≠ se usa 'url' en lugar de 'text'
            { url: IMAGE_URL_2 }
        ];
    }

    // Si ambos o ninguno est√°n presentes, retorna nulo para el flujo normal
    return null;
}

// ---------------------------------------------
// Flujo Principal de Triggers
// ---------------------------------------------

function checkTriggers(message) {
    const lowerCaseMessage = message.toLowerCase();
    const trimmedMessage = lowerCaseMessage.trim();
    
    // Mapa de triggers num√©ricos y de palabras clave
    const menuMap = { 
        '1': 'iva', 
        '2': 'empresa', 
        '3': 'aut√≥nomo', 
        
        // Sub-opciones
        'ampliada': 'ampliada', 'ejemplo': 'ejemplo', 'obligaciones': 'obligaciones',
        'legales': 'legales', 'tramites': 'tramites', 'recomendaciones': 'recomendaciones',
        'masinfo': 'masinfo'
    };

    // 1. Chequea el caso complejo (Registro/Dise√±o de Marca)
    const consultorResponse = checkCasosConsultor(message);
    if (consultorResponse) {
        return consultorResponse; 
    }
    
    // 2. Determina la palabra clave del mensaje para el men√∫ principal
    let keyword = null;

    if (menuMap[trimmedMessage]) {
        keyword = menuMap[trimmedMessage];
    } else {
        for (const key in TRIGGERS_MENU) {
            if (lowerCaseMessage.includes(key) && key.length > 2) { 
                keyword = key;
                break;
            }
        }
    }

    if (keyword && TRIGGERS_MENU[keyword]) {
        const response = TRIGGERS_MENU[keyword];
        
        if (Array.isArray(response)) {
            return response;
        } 
        else {
            return [response];
        }
    }
    
    return null; 
}

// ---------------------------------------------
// Conexi√≥n a IA (Simulaci√≥n del Consultor)
// ---------------------------------------------

async function getAIResponse(prompt) {
    // Respuesta gen√©rica para consultas fuera del men√∫ o sin trigger espec√≠fico
    return [{ text: `**¬°Genial!** Tu consulta sobre "${prompt}" es espec√≠fica y merece un an√°lisis detallado. Te recomiendo agendar una cita con un consultor para revisar la viabilidad legal y fiscal de ese punto.` }];
}

// ---------------------------------------------
// Ruta de la API
// ---------------------------------------------

app.post('/api/message', async (req, res) => {
    const userMessage = req.body.message;
    
    let botResponses = []; 

    if (!userMessage || userMessage.trim() === '') {
        botResponses.push({ text: "No recib√≠ tu mensaje. ¬øPodr√≠as repetirlo?" });
    } else {
        const detectedResponse = checkTriggers(userMessage);

        if (detectedResponse) {
            botResponses = detectedResponse; 
        } else {
            botResponses = await getAIResponse(userMessage);
        }
    }

    res.json({ responses: botResponses });
});

// ---------------------------------------------
// Inicio del Servidor
// ---------------------------------------------

app.listen(PORT, () => {
    console.log(`‚úÖ Servidor Backend Consultor de IA corriendo en http://localhost:${PORT}`);
});